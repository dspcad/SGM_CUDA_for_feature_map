#include "semi_global_matching.hpp"

using namespace std;
using namespace sgsm;

int main(int argc, char* argv[]){
    cout << "Test Case 6" << endl;


    const unsigned long h = 5;
    const unsigned long w = 5;
    const unsigned long c = 8;
    
    const int num_disparity = 3;
    const int kernel_size = 3;

    const int N = h*w*c;
    double left_feat_map_5x5x8[N] = { 38.01,-34.55,-40.13,-22.46,-29.05,
	                              67.13, 50.60, 19.67, 11.39, 78.44,
	                              64.30, 51.27,-33.72, 90.90, 51.05,  
				      37.54, 44.77, 63.83, -1.77, -7.64,
				     -71.31,  4.62, 66.33,-15.65,-75.76,
				     
				     -38.31, 32.89, 44.30, 34.75, 23.66,
				       2.05,-40.63,-15.94,-16.14, 94.08,
				     -42.77, 22.76, 86.77, 94.92,-77.39,
				      69.06, 32.05, -9.88, 69.38, 34.71,
				     -67.10, -8.24,-12.70, 76.61, 82.73,

				     -97.16, 51.98,-47.49,-50.57,-44.09,
				      61.39,-60.58, 66.84,-22.12,-43.24,
				      -8.07,-96.41, 99.11, 54.28, 50.09,
				     -50.61, 16.82,-84.45, -1.99, 30.57,
				      43.90,-61.26,-52.74,-26.83, 11.21,
				     
				      41.17,-84.42, 18.10, 98.50,-85.56,
				      48.04, 69.05, 38.77,-77.64, 46.46,
				      37.75,-45.29,-19.61,-68.50, 23.80,
				      74.57,-96.12, 91.85,  0.37,-79.49,
				     -66.12,-30.84,-93.39,-41.90, 36.42,

				      95.28, 60.19, 10.87,-49.67, 47.70,
				     -44.30, 28.39, 90.42, 49.28,-24.88,
				      25.50,-51.21, 48.19, 92.22,-53.43,
				     -82.77,-29.89, 53.99, 76.04, 90.38,
				       0.97,-76.52,-24.64,-89.96,-74.74,

				     -79.54, 53.64,-39.34, 50.93,-60.23,
				     -19.56, 74.02, 31.80, 65.60, 92.32,
				     -16.40, 92.49,-28.60, 56.88,-64.63,
				     -79.05, 66.79, 84.68, 59.43, 10.44,
				      90.88,-70.94,-11.57, 22.18,-82.84,

				     -15.19, 74.01,-11.43, 43.70,-72.36,
				      54.40,  9.51, 30.23, 33.98,-13.86,
				     -82.86,-72.18,-62.03,  8.68,-35.14,
				     -71.26, -4.60, 61.04,-76.17,-50.69,
				      97.01, 63.90,-25.19,-43.12,-26.51,

				      88.50,-59.59, 28.71,-99.56,  0.09,
				     -46.63,  1.16, 83.53,-55.45, 51.30,
				     -22.48, 59.24,-72.76, -0.72, 44.53,
				     -39.24,-50.25,  9.75, 66.98, 41.18,
				      73.65,-64.68,-17.24, 74.13,-40.40
                                    };


    double right_feat_map_5x5x8[N] = { 87.12,-21.55, 79.80,-56.97, 92.91,
	                              -23.13,  8.85,-57.81, 42.93, 69.36,
	                                8.06, 95.28,-89.29, 71.80, 56.96,
				      -67.53,-93.81, 49.86, 76.82,-66.79,
				      -93.33,-90.17, 54.21, 81.23, 62.59,
				      
				      -19.66, 78.41,-98.56, 68.99,-14.61,
				      -28.81,-95.62, 35.14,-76.52,-19.45,
				       50.46,  3.97,-15.49, 94.81, 91.68,
				       39.14,-83.10,-64.48, 68.10,  5.29,
				      -39.16,-20.12, 32.38,-96.88, 23.03,

				       -1.31,-43.32,  5.57, 60.09,  9.31,
				       96.65, 64.93,-99.40,-27.68, 86.33,
				       -1.65,-63.90,-89.63,-14.27, 88.02,
				      -74.61,-85.46,-73.35, 22.94,-39.97,
				       -6.72,-20.57, 43.30,-54.31, 10.01,

				      -27.29,-39.19, 52.98, 99.50,-24.35,
				      -10.40, 92.97,  1.17, -2.79, 36.23,
				       44.20,  8.93, 55.71,-67.66, 55.24,
				      -18.80, 75.34, 29.18,-70.35, -4.60,
				       45.49,-58.95, 46.93, -1.66, 57.08,

				      -37.10,-73.81,-63.74,-14.46, 85.72,
				       42.57, 63.36, 93.04, 38.63,-83.67,
				       79.39, 86.03,-79.26, 76.98,-52.90,
				      -89.95, 65.98, 31.60,-79.55, 84.28,
				       58.01, 20.32, 94.18, 11.57,-97.16,

				      -49.82,-99.99, 62.12, 12.64, 83.46,
				       37.12, 72.00, 46.11, 17.16,-55.76,
				       17.17, 88.58,-89.26, 78.58,-99.30,
				       71.76,-85.53, 19.34,-45.06, -2.80,
				       94.12,-67.57, -4.71,-45.71,-27.52,

				      -18.56, 55.97, 45.54,-72.38, 74.01,
				       -0.31, 47.47, 73.43,-34.09, 85.07,
				       22.82,-67.01, -5.95,-71.83,  6.19,
				      -39.74,-85.94,-50.20, 49.74, 18.46,
				      -25.35,-72.44, -6.59,-72.46, 22.01,

				       -7.66, 69.72,-28.33, 46.61,-27.43,
				      -60.37, 91.23,  6.96, 16.79,-67.28,
				      -76.77, 63.29,-91.50, 89.26, 44.87,
				      -78.29, -3.51, 80.35,-97.59, 57.90,
				      -15.84, 78.76, 56.37, -4.10,-13.36
                                    };

    const int out_N = h*w;
    double out[out_N];


    double *d_left_feat_map, *d_right_feat_map;
    double *d_out;

    cudaMalloc((void **)&d_left_feat_map, sizeof(double)*N); 
    cudaMalloc((void **)&d_right_feat_map, sizeof(double)*N); 
    cudaMalloc((void **)&d_out,      sizeof(double)*out_N);

    cudaMemcpy(d_left_feat_map,  left_feat_map_5x5x8,  sizeof(double)*N, cudaMemcpyHostToDevice);
    cudaMemcpy(d_right_feat_map, right_feat_map_5x5x8, sizeof(double)*N, cudaMemcpyHostToDevice);


    const dim3 threadsPerBlock(w, h);

    sum_diff_transform_cuda<<<threadsPerBlock,1>>>(d_out,
                                                   d_left_feat_map,
                                                   d_right_feat_map,
                                                   c,
                                                   h,
                                                   w,
                                                   kernel_size,
                                                   kernel_size,
						   num_disparity,
						   REF_IMG::LEFT
                                                   );

    cudaMemcpy(out,d_out,sizeof(unsigned int)*out_N,cudaMemcpyDeviceToHost);



    cudaFree(d_left_feat_map);
    cudaFree(d_right_feat_map);
    cudaFree(d_out);


    return 0;
}
